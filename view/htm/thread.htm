<?php include "./view/htm/header.inc.htm"; ?>


<div class="row m-t-1">
	<div class="col-lg-8">
		<ol class="breadcrumb m-b-sm hidden-lg-down">
			<li><a href="./"><i class="icon-home"></i></a></li>
			<li><a href="<?php echo url("forum-$fid");?>"><?php echo $forum['name'];?></a></li>
			<li><a href="<?php echo url("thread-$tid");?>"><?php echo $thread['subject'];?></a></li>
		</ol>
		<div class="card p-a-1">
			<dl class="row">
				<dt class="vtop p-r-1 avatar-parent">
					<a href="<?php echo url("user-$thread[uid]");?>">
						<img class="avatar" src="<?php echo $thread['user_avatar_url'];?>">
					</a>
				</dt>
				<dd>
					<h3><?php echo $thread['subject'];?></h3>
					<dl class="row small">
						<dt>
							<span class="username text-muted"><?php echo $thread['username'];?></span>
							<span class="date text-grey m-l-1"><?php echo $thread['create_date_fmt'];?></span>
						</dt>
						<dd class="text-right">
							<?php if($allowupdate || $first['allowupdate']) { ?>
							<a href="<?php echo url("post-update-$thread[firstpid]");?>" class="text-grey m-r-1 post_update"><i class="icon-edit"></i> <?php echo lang('edit');?></a>
							<?php } ?>
							
							<?php if($allowdelete || $first['allowdelete']) { ?>
							<a href="<?php echo url("post-delete-$thread[firstpid]");?>" class="text-grey post_delete"><i class="icon-remove"></i> <?php echo lang('delete');?></a>
							<?php } ?>
						</dd>
					</dl>
				</dd>
			</dl>
			<hr></hr>
			<div class="message">
				<?php echo $first['message'];?>
			</div>
		</div>
		
		<div class="card post p-a-1">
			<table class="table table-hover postlist">
				<thead>
					<tr>
						<th colspan="2" class="p-t-0 p-l-0">
							<dl class="row">
								<dt>
									<b>最新回复</b>(<span class="posts"><?php echo $thread['posts'];?></span>)
								</dt>
								<dd>
								
								</dd>
							</dl>
						</th>
					</tr>
				</thead>
				<tbody>
					<?php include 'view/htm/post_list.inc.htm'; ?>
					<tr class="post">
						<td class="avatar-parent">
							<a href="<?php echo url("user-$thread[uid]");?>">
								<img class="avatar" src="<?php echo $user['avatar_url'];?>">
							</a>
						</td>
						<td class="p-l-0">
							<form action="<?php echo url("post-create-$tid-1");?>" method="post" id="form">	
								<dl class="row small text-muted">
									<dt class="username"><?php echo $user['username'];?></dt>
									<dd class="text-right text-grey"><span class="floor"><?php echo ($thread['posts'] + 1);?></span>楼</dd>
								</dl>
								<div class="message m-t-xs">
									<fieldset class="form-group">
										<textarea class="form-control" placeholder="<?php echo lang('message');?>" name="message" id="message" style="height: 100px;"></textarea>
									</fieldset>
								</div>
								<div class="text-muted  m-t-xs date">
									<button type="submit" class="btn btn-primary" id="submit" data-loading-text="<?php echo lang('submiting');?>..."> <?php echo lang('post_create');?> </button>
								</div>
							</form>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		
	</div>
	<div class="col-lg-4">
		<div class="card hidden-lg-down">
			<a href="<?php echo url("user-$thread[uid]");?>">
				<img class="avatar-lg center-block m-t-1" src="<?php echo $thread['user_avatar_url'];?>">
			</a>
			<h5 class="text-xs-center"><?php echo $thread['username'];?></h5>
			<div class="card-group card-group-nest">
				<div class="card">
					<div class="card-block">
						<div class="text-xs-center text-muted small">主题</div>
						<h5 class="text-xs-center"><?php echo $thread['user']['threads'];?></h5>
					</div>
				</div>
				<div class="card">
					<div class="card-block">
						<div class="text-xs-center text-muted small">回复</div>
						<h5 class="text-xs-center"><?php echo $thread['user']['posts'];?></h5>
					</div>
				</div>
				<div class="card">
					<div class="card-block">
						<div class="text-xs-center text-muted small">注册排名</div>
						<h5 class="text-xs-center"><?php echo $thread['user']['uid'];?></h5>
					</div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-block">
				<b>作者最近主题</b>
				<hr class="m-t-sm" />
				<ul>
					<li>版块公告内容版块公告内容版块公告内容版块公告内容版块公告内容 - 2 天前</li>
					<li>版块公告内容版块公告内容版块公告内容版块公告内容版块公告内容 - 2 天前</li>
					<li>版块公告内容版块公告内容版块公告内容版块公告内容版块公告内容 - 2 天前</li>
					<li>版块公告内容版块公告内容版块公告内容版块公告内容版块公告内容 - 2 天前</li>
				</ul>
			</div>
		</div>
	</div>
</div>

<?php include "./view/htm/footer.inc.htm"; ?>

<script>
var jform = $('#form');
var jsubmit = $('#submit');
jform.on('submit', function() {
	var postdata = jform.serialize();
	jsubmit.button('loading');
	$.xpost(jform.attr('action'), postdata, function(code, message) {
		if(code == 0) {
			var s = '<table>'+message+'</table>';
			var jtr = $(s).find('tr');
			jtr.insertBefore($('table.postlist tr').last());
			jsubmit.button('reset');
			$('#message').val('');
			
			// 楼层 +1
			var jfloor = jform.find('.floor');
			jfloor.html(intval(jfloor.html()) + 1);
			
			// 回复数 +1
			var jposts = $('.posts');
			jposts.html(intval(jposts.html()) + 1);
			
		} else if(code < 0) {
			alert(message);
			jsubmit.button('reset');
		} else {
			jform.find('[name="'+code+'"]').alert(message).focus();
			jsubmit.button('reset');
		}
	});
	return false;
});

// 删除帖子
var jpost_delete = $('.post_delete');
jpost_delete.on('click', function() {
	var jthis = $(this);
	var href = jthis.attr('href');
	var isfirst = jthis.attr('isfirst');
	if(window.confirm('确定删除？')) {
		$.xpost(href, function(code, message) {
			if(code == 0) {
				if(isfirst) {
					$.location('<?php echo url("forum-$fid");?>');
				} else {
					// 删掉楼层
					jthis.parents('tr').remove();
					// 回复数 -1
					var jposts = $('.posts');
					jposts.html(intval(jposts.html()) + 1);
				}
			} else {
				alert(message);
			}
		});
	}
	return false;
});
</script>