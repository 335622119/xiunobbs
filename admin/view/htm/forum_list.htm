<?php include './view/htm/header.inc.htm'; ?>

<div class="row">
	<div class="col-lg-10 col-lg-offset-1">
		<div class="card">
			<div class="card-block">
				<form action="<?php echo url('forum-list');?>" method="post" id="form">
					<h4 class="card-title">版块列表</h4>
					<div class="table-responsive arrlist">
						<table class="table" style="min-width: 800px">
							<thead>
								<tr align="center">
									<th width="80">版块ID</th>
									<th width="60" align="left">图标</th>
									<th width="130"></th>
									<th>名称</th>
									<th width="100">排序</th>
									<th width="100" class="text-center">编辑</th>
									<th width="100" class="text-center">删除</th>
								</tr>
							<thead>
							<tbody>
								<?php foreach($forumlist as $_fid=>$_forum) { ?>
								<tr align="center" rowid="<?php echo $_fid; ?>">
									<td class="50"><input type="text" class="form-control" name="fid[<?php echo $_fid;?>]" value="<?php echo $_forum['fid']; ?>"  placeholder="版块ID" /></td>
									<td align="left">
										<img src="../<?php echo $_forum['icon_url']; ?>" class="forum" width="48" id="img_<?php echo $_fid;?>" />
									</td>
									<td>
										<input type="file" multiple="multiple" accept=".jpg,.jpeg,.png,.gif,.bmp" class="form-control" name="icon[<?php echo $_fid;?>]" value="" data-assoc="img_<?php echo $_fid;?>" placeholder="版块图标" />
									</td>
									<td><input type="text" class="form-control" name="name[<?php echo $_fid;?>]" value="<?php echo $_forum['name']; ?>" placeholder="名称" /></td>
									<td><input type="text" class="form-control" name="rank[<?php echo $_fid;?>]" value="<?php echo $_forum['rank']; ?>" placeholder="顺序" /></td>
									<td><a class="btn row_edit" role="btn">编辑</a></td>
									<td><a class="btn row_delete" role="btn">删除</a></td>
								</tr>
								<?php } ?>
							</tbody>
						</table>
					</div>
					<p><a role="button" class="btn row_add">[+]增加一行</a></p>
					<p class="text-center">
						<button type="submit" class="btn btn-primary" id="submit" data-loading-text="<?php echo lang('submiting');?>..." style="width: 10rem;"><?php echo lang('confirm');?></button>
					</p>
				</form>
			</div>
		</div>
	</div>
</div>

<?php include './view/htm/footer.inc.htm'; ?>

<script>

if(!debug) $.alert('请谨慎编辑版块，一旦确定后不要轻易变动，否则可能会导致数据关联错误，一般在正式运营时就不要再变动。', 4);

var maxfid = <?php echo $maxfid;?>;

var jform = $("#form");
var jsubmit = $("#submit");

jform.base64_encode_file(); // 对文件进行 base64 编码，处理文件上传，很方便

jform.on('submit', function(){
	jform.reset();
	var postdata = jform.serialize();
	jsubmit.button('loading');
	$.xpost(jform.attr('action'), postdata, function(code, message) {
		if(code == 0) {
			$.alert(message);
			jsubmit.text(message).delay(3000).location();
			return;
		} else {
			alert(message);
			jsubmit.button('reset');
		}
	});
	return false;
});

// 编辑
var jarrlist = $('.arrlist');
var jedit = $('a.row_edit');
jarrlist.on('click', 'a.row_edit', function() {
	var jthis = $(this);
	var jtr = jthis.parents('tr');
	var rowid = jtr.attr('rowid');
	window.location = xn.url('forum-update-'+rowid);
});

// 删除
var jdelete = $('a.row_delete');
jarrlist.on('click', 'a.row_delete', function() {
	var jthis = $(this);
	var jtr = jthis.parents('tr');
	var rowid = jtr.attr('rowid');
	if(rowid == 1) {
		$.alert('不能删除系统保留的版块。');
		return;
	}
	jtr.remove();
	return false;
});
// 增加
var jadd = $('a.row_add');
jadd.on('click', function() {
	var jclone = jarrlist.find('tr').last().clone();
	jclone.insertAfter(jarrlist.find('tr').last());
	var jfid = jclone.find('input[name^="fid"]');
	//var rowid = xn.intval(jfid.val()) + 1;
	var rowid = ++maxfid;
	jfid.val(rowid);
	jclone.attr('rowid', rowid);
	
	// 清空值
	jclone.find('input').not('[name^="fid"]').val('');
	
	// 修改 [] 中的值为 rowid
	jclone.find('input').attr_name_index(rowid);
	
	// 图片缩略
	jclone.find('img.forum').attr('id', 'img_'+rowid).attr('src', '../view/img/forum.png');
	jclone.find('input[type="file"]').attr('data-assoc', 'img_'+rowid);
	
	return false;
});


$('#nav_pc li.forum').tab('show');
$('#nav_mobile li.forum').tab('show');


</script>