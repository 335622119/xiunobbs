<?php include "./view/htm/header.inc.htm"; ?>

<?php
	// 公用一个模板
	if($route == 'thread' && $action == 'create') {
		$form_title = lang('thread_create');
		$form_action = url("thread-create-'+jfid.val()");
		$form_subject = '';
		$form_message = '';
		$form_doctype = 1;
		$isfirst = 1;
		$location = url("forum-$fid");
	} elseif($route == 'post' && $action == 'update') {
		$form_title = lang('post_update');
		$form_action = url("post-update-$pid");
		$form_subject = '';
		$form_message = $post['message'];
		$form_doctype = $post['doctype'];
		$isfirst = $post['isfirst'];
		$location = url("thread-$tid");
	} elseif($route == 'post' && $action == 'create') {
		$form_title = lang('post_create');
		$form_action = url("post-create-$tid");
		$form_subject = '';
		$form_message = '';
		$form_doctype = 1;
		$isfirst = 0;
		$location = url("thread-$tid");
	}
?>

<div class="row">
	<div class="col-lg-10 col-lg-offset-1">
		<div class="card">
			<div class="card-block">
				<h4 class="card-title"><?php echo $form_title; ?></h4>
				<form action="<?php echo $form_action;?>" method="post" id="form">
					<input type="hidden" name="doctype" value="<?php echo $form_doctype;?>" />
					
					<?php if($isfirst) { ?>
					
					<div class="row">
						<div class="col-lg-9">
							<fieldset class="form-group">
								<input type="text" class="form-control" placeholder="<?php echo lang('subject');?>" name="subject" value="<?php echo $form_subject;?>" id="subject">
							</fieldset>
						</div>
						<div class="col-lg-3">
							<fieldset class="form-group">
								<select class="c-select" name="fid">
									<?php foreach ($forumlist_show as $forum) { ?>
									<option value="<?php echo $forum['fid']; ?>"><?php echo $forum['name']; ?></option>
									<?php } ?>
								</select>
							</fieldset>
							<!--{hook thread_create_subject_right.htm}-->
						</div>
					</div>
					
					<?php } ?>
					
					<fieldset class="form-group">
						<textarea class="form-control" placeholder="<?php echo lang('message');?>" name="message" id="message" style="height: 300px;"><?php echo $form_message;?></textarea>
					</fieldset>
					<div class="row">
						<div class="col-lg-10">
							<p class="small text-left"><label class="addattach" id="addattach"><i class="icon-folder-open-alt"></i> <span>添加附件</span><input type="file" /></label></p>
							<ul id="attachlist" class="small"></ul>
							<!--{hook thread_create_bottom_right.htm}-->
						</div>
						<div class="col-lg-2 text-right">
							<button type="submit" class="btn btn-primary" id="submit" data-loading-text="<?php echo lang('submiting');?>..."> <?php echo lang('post_update');?> </button>
							<!--{hook thread_create_bottom_left.htm}-->
						</div>
					</div>
					
				</form>
			</div>
		</div>
	</div>
</div>

<?php include "./view/htm/footer.inc.htm"; ?>


<script>
var jform = $('#form');
var jsubmit = $('#submit');
var jfid = jform.find('input[name="fid"]');
jform.on('submit', function() {
	var postdata = jform.serialize();
	jsubmit.button('loading');
	$.xpost(jform.attr('action'), postdata, function(code, message) {
		if(code == 0) {
			$.alert(message);
			jsubmit.button(message).delay(3000).location('<?php echo $location;?>');
		} else if(code < 0) {
			alert(message);
			jsubmit.button('reset');
		} else {
			jform.find('[name="'+code+'"]').alert(message).focus();
			jsubmit.button('reset');
		}
	});
	return false;
});


var jaddattach = $('#addattach');
var jattachlist = $('#attachlist');
jaddattach.on('change', function(e) {
	var files = xn.get_files_from_event(e);
	if(!files) return;
	xn.upload_file(files[0], xn.url('attach-create'), function(code, message) {
		// 把文件 append 到附件列表
		var url = message.url;
		var filetype = message.filetype;
		jattachlist.append('<li><a href="'+message.url+'" target="_blank"><i class="icon filetype '+filetype+'"></i> '+message.name+'</a></li>');
	});
});

jform.find('[name="fid"]').checked(<?php echo $fid;?>);
$('#nav_pc li[fid="<?php echo $fid;?>"]').tab('show');
$('#nav_mobile li[fid="<?php echo $fid;?>"]').tab('show');

</script>

<link href="plugin/xn_umeditor/themes/default/css/umeditor.min.css<?php echo $static_version;?>" type="text/css" rel="stylesheet" />
<link href="plugin/xn_umeditor/umeditor-bbs.css<?php echo $static_version;?>" type="text/css" rel="stylesheet" />
<script type="text/javascript" src="plugin/xn_umeditor/umeditor.config.js<?php echo $static_version;?>"></script>
<script type="text/javascript" src="plugin/xn_umeditor/umeditor.js<?php echo $static_version;?>"></script>
<script type="text/javascript" src="plugin/xn_umeditor/umeditor-bbs.js<?php echo $static_version;?>"></script>
<script type="text/javascript" src="plugin/xn_umeditor/lang/zh-cn/zh-cn.js<?php echo $static_version;?>"></script>

<?php if($route == 'thread' && $action == 'create') { ?>

<script>

</script>

<?php } elseif($route == 'post' && $action == 'update') { ?>

<script>
</script>

<?php } elseif($route == 'post' && $action == 'create') { ?>

<script>
</script>

<?php } ?>