<?php include "./view/htm/header.inc.htm"; ?>

<div class="row">
	<div class="col-lg-6 col-lg-offset-3">
		<div class="card p-a-sm">
			<h3>修改头像</h3>
			<hr />
			<div style="width: 60%; margin: auto;">
				<p class="text-center">
					<img class="m-t-0" data-src="holder.js/100%x180" alt="100%x180" src="view/img/avatar.png" width="100" height="100">
				</p>
				<p class="text-center">
					<!--
					<label class="file">
						<input type="file" id="file">
						<span class="file-custom"></span>
					</label>
					-->
					<input type="file" id="avatar_upload" accept=".jpg,.jpeg,.png,.gif,.bmp"  class="upload" style="width: 200px; opacity: 0.7" value="更换头像"/>
				</p>
				<div style="width: 100%; height: 12px; border: 1px border green; margin-top: 2px;" id="avatar_progress"><div style="width: 0px;  height: 12px; background: green;"></div></div>
			</div>
		</div>
		<a role="button" class="btn btn-primary center-block" href="<?php echo url('my');?>"> <?php echo lang('back');?> </a>
	</div>
</div>

<?php include "./view/htm/footer.inc.htm"; ?>


<script src="view/js/async.js"></script>
<script src="view/js/upload.js"></script>

<script>
$('#avatar_upload').one('click', function() {
	var fileinput = this;
	var jfile = $(fileinput);
	var jimg = $('#avatar_img');
	var url = 'my-uploadavatar.htm';
	var up = new FileUploader(fileinput, url);
	up.filetype = 'image/png';
	up.thumb_width = 64;
	up.onprogress = function(file, percent) {
		$('#avatar_progress').show().son('div').width(percent+'%');
	}
	up.ononce = function(file, e) {
		var json = json_decode(e.target.response);
		if(json && json.code == 0) {
			$('#avatar_img').attr('src', json.message+'?'+Math.random());
		} else {
			var err = json && json.message ? json.message : e.target.response;
			alert(err);
		}
		setTimeout(function() {$('#avatar_progress').son('div').width(0)}, 2000);
	}
	up.oncomplete = function(code, files) {
		if(code == 0) {
			//$.alert('ok');
		} else {
			//alert(code);
		}
	}
	up.onselected = function(files) {
		var file = files[0];
		jimg.srcLocalFile(file);
		if(!/^image/.test(file.type) || !/(.jpg|.jpeg|.gif|.png|.bmp)$/i.test(file.type)) {
			jfile.popover('只允许上传jpg、jpeg、gif、png格式的图片'); return;
		}
		up.start();
	}
	
	up.onerror = function(file, e) {
		var json = json_decode(e.target.response);
		var err = json && json.message ? json.message : e.target.response;
		jfile.popover(err); return;
	}
	up.onabort = function(file, e) {}
	up.init();
});

</script>